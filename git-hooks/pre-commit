#!/bin/sh
set -eu

echo "Running pre-commit checks..."

# git-hooks/ と .git/hooks/ の差分をチェック
check_hooks_diff() {
    for file in git-hooks/*; do
        filename=$(basename "$file")
        target=".git/hooks/$filename"
        if [ ! -f "$target" ] || ! diff -q "$file" "$target" >/dev/null 2>&1; then
            return 1
        fi
    done
}

if ! check_hooks_diff; then
    echo "git-hooks/ has been updated. Copying hooks..."
    cp git-hooks/* .git/hooks/
    echo "Hooks updated. Please run 'git commit' again."
    exit 1
fi

# Get list of staged Python files
STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -z "$STAGED_PY_FILES" ]; then
    echo "No Python files staged for commit."
    exit 0
fi

echo "Staged Python files:"
echo "$STAGED_PY_FILES"

# Check if uv is available
if ! command -v uv &> /dev/null; then
    echo "❌ Error: uv is not installed."
    echo "Please install uv: https://github.com/astral-sh/uv"
    exit 1
fi

# Check if dev dependencies are installed
echo "Checking dev dependencies..."
if ! uv pip list | grep -q "ruff"; then
    echo "Installing dev dependencies..."
    uv sync --group dev
fi

# Run ruff linter
echo "Running ruff linter..."
if ! uv run ruff check $STAGED_PY_FILES; then
    echo "❌ Ruff linter failed. Please fix the errors above."
    exit 1
fi

# Run ruff formatter check
echo "Checking code formatting with ruff..."
if ! uv run ruff format --check $STAGED_PY_FILES; then
    echo "❌ Code formatting check failed."
    echo "Run 'uv run ruff format $STAGED_PY_FILES' to fix formatting."
    exit 1
fi

# Run type checker (mypy)
echo "Running type checker (mypy)..."
if ! uv run mypy $STAGED_PY_FILES --ignore-missing-imports; then
    echo "⚠️  Type checking failed (non-blocking)."
    echo "Consider fixing type issues."
fi

echo "✅ All pre-commit checks passed!"
exit 0
